generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id                       String       @id @default(cuid())
  brand                    String
  name                     String
  species                  String       @default("DOG")
  lifestage                String?
  foodtype                 String?
  mainprotein              String?
  isgrainfree              Boolean?     @default(false)
  crudeprotein             Float
  crudefat                 Float
  crudefiber               Float
  crudeash                 Float
  crudemoisture            Float
  hasaafco                 Boolean?     @default(false)
  hasfediaf                Boolean?     @default(false)
  createdat                DateTime?    @default(now()) @db.Timestamp(6)
  updatedat                DateTime?    @default(now()) @db.Timestamp(6)
  caloriesestimatedper100g Float?
  caloriesestimationnote   String?
  caloriesper100g          Float?
  caloriessource           String?
  priority                 Int?         @default(0)
  targetconditions         String[]
  image                    String?
  ProductSKU               ProductSKU[]
}

model ProductSKU {
  id              String           @id
  productid       String
  weight          Float
  price           Int
  image           String?
  purchaselink    String?
  createdat       DateTime?        @default(now()) @db.Timestamp(6)
  updatedat       DateTime?        @default(now()) @db.Timestamp(6)
  clickcount      Int?             @default(0)
  Product         Product          @relation(fields: [productid], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sku_price_rollups sku_price_rollups?
}

model sku_price_rollups {
  sku_id        String     @id
  current_price Int
  year_min      Int
  year_max      Int
  updated_at    DateTime?  @default(now()) @db.Timestamp(6)
  ProductSKU    ProductSKU @relation(fields: [sku_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([sku_id])
}

model dog_breeds {
  id              BigInt    @id @default(autoincrement())
  slug            String    @unique
  name_ko         String
  name_en         String?
  aliases         String[]
  popularity_rank Int?
  is_mixed        Boolean?  @default(false)
  is_unknown      Boolean?  @default(false)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @default(now()) @db.Timestamp(6)
}

model cat_breeds {
  id              BigInt    @id @default(autoincrement())
  slug            String    @unique
  name_ko         String
  name_en         String?
  aliases         String[]
  popularity_rank Int?
  is_mixed        Boolean?  @default(false)
  is_unknown      Boolean?  @default(false)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @default(now()) @db.Timestamp(6)
}

model pet_profiles {
  id            String    @id @default(uuid()) @db.Uuid
  user_id       String    @db.Uuid
  name          String
  species       String    // "DOG" | "CAT"
  breed_id      String?
  breed_name    String?
  weight_kg     Float
  is_neutered   Boolean   @default(false)
  activity_level Int      @default(3) // 1~5
  allergies     String[]
  birth_date    DateTime?
  image_url     String?
  is_active     Boolean   @default(true)
  created_at    DateTime  @default(now()) @db.Timestamp(6)
  updated_at    DateTime  @default(now()) @db.Timestamp(6)

  @@index([user_id])
  
  posts         Post[]
}

model walk_sessions {
  id          String   @id @default(cuid())
  user_id     String   @db.Uuid
  pet_id      String
  pet_name    String
  pet_species String
  started_at  DateTime @db.Timestamp(6)
  ended_at    DateTime @db.Timestamp(6)
  duration_ms Int
  distance_km Float?
  notes       String?
  created_at  DateTime @default(now()) @db.Timestamp(6)

  @@index([user_id])
  @@index([pet_id])
}

model user_profiles {
  id              String    @id @default(cuid())
  user_id         String    @unique @db.Uuid
  nickname        String
  has_pet         Boolean
  interests       String[]
  region          String?
  age_group       String?
  referral_source String?
  created_at      DateTime  @default(now()) @db.Timestamp(6)
  updated_at      DateTime  @default(now()) @db.Timestamp(6)

  @@index([user_id])

  posts         Post[]
  comments      Comment[]
  likes         PostLike[]
}


// --- Community Feature ---

enum PostCategory {
  CHAT      // 수다
  QUESTION  // 질문
  TIP       // 정보/팁
  REVIEW    // 후기
}

model Post {
  id          String       @id @default(dbgenerated("gen_random_uuid()"))
  categoryId  PostCategory @default(CHAT) @map("category_id")
  title       String
  content     String
  images      String[]     // JSON array of image URLs
  viewCount   Int          @default(0) @map("view_count")
  
  authorId    String       @db.Uuid @map("author_id")
  author      user_profiles @relation(fields: [authorId], references: [user_id])
  
  petId       String?      @db.Uuid @map("pet_id")
  pet         pet_profiles? @relation(fields: [petId], references: [id])
  
  comments    Comment[]
  likes       PostLike[]
  
  createdAt   DateTime     @default(now()) @db.Timestamp(6) @map("created_at")
  updatedAt   DateTime     @default(now()) @updatedAt @db.Timestamp(6) @map("updated_at")

  @@index([authorId])
  @@index([categoryId])
  @@map("posts")
}

model Comment {
  id        String        @id @default(dbgenerated("gen_random_uuid()"))
  content   String
  
  postId    String        @map("post_id")
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId  String        @db.Uuid @map("author_id")
  author    user_profiles @relation(fields: [authorId], references: [user_id])
  
  createdAt DateTime      @default(now()) @db.Timestamp(6) @map("created_at")
  updatedAt DateTime      @default(now()) @updatedAt @db.Timestamp(6) @map("updated_at")

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

model PostLike {
  postId    String        @map("post_id")
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String        @db.Uuid @map("user_id")
  user      user_profiles @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  
  createdAt DateTime      @default(now()) @db.Timestamp(6) @map("created_at")

  @@id([postId, userId])
  @@index([userId])
  @@map("post_likes")
}
